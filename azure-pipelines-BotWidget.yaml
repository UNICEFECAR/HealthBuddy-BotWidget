trigger:
  branches:
    include:
    - develop
  paths:
    include:
    - src


variables:
  azSubscription: 'hbcovid-dev1'
  dev1_storageaccount_mob: 'saeuwdev1hbcovid01mob'

stages:

- stage: build
  displayName: build

  jobs:
  - job: npmbuild
    pool:
      vmImage: 'vs2017-win2016'

    steps:

    - script: |
        npm install
      displayName: 'npm install'

    - script: |
        npm run build
      displayName: 'npm run build'
      
    - task: ArchiveFiles@2
      displayName: 'Archive files'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/dist'
        includeRootFolder: true
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true

    - task: PublishPipelineArtifact@0
      displayName: 'Publish artifacts'
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip


- stage: dev1
  dependsOn:
  - build  
  condition: succeeded('build')

  jobs:
  - deployment: deploy
    displayName: Deploy dev1-chatbot
    environment: 'dev1-chatbot'
    pool:
      vmImage: 'vs2017-win2016'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: DownloadPipelineArtifact@1
              displayName: 'Download Pipeline Artifacts'
              inputs:
                buildType: 'current'
            - task: ExtractFiles@1
              displayName: Extract Files
              inputs:
                archiveFilePatterns: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                destinationFolder: '$(System.DefaultWorkingDirectory)/unzip/$(Build.BuildId)'
                cleanDestinationFolder: true

            - task: AzureCLI@2
              displayName: Delete old content from BLOB $web
              inputs:
                azureSubscription: $(azSubscription)
                scriptType: ps
                scriptLocation: inlineScript
                inlineScript: |
                  az storage blob delete-batch --account-name $(dev1_storageaccount_mob) --source `$web 

            - task: AzureFileCopy@3
              displayName: Deploy to BLOB $web
              inputs:
                SourcePath: '$(System.DefaultWorkingDirectory)/unzip/$(Build.BuildId)/dist'
                azureSubscription: $(azSubscription)
                Destination: 'AzureBlob'
                storage: $(dev1_storageaccount_mob)
                ContainerName: '$web'

